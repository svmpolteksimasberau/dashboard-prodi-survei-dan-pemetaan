<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Dosen - PSBC Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .stat-glass { background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(12px); border: 1px solid rgba(255,255,255,0.2); }
    </style>
</head>
<body class="min-h-screen pb-12">

    <nav class="bg-blue-900 text-white p-10 pb-32 rounded-b-[4rem] shadow-2xl relative overflow-hidden">
        <div class="container mx-auto relative z-10">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="text-[10px] font-black text-orange-400 uppercase tracking-widest mb-2 italic">Dosen Analytics Hub</p>
                    <h1 id="dosenGreet" class="font-black text-3xl tracking-tighter uppercase italic text-white leading-none">Halo, Dosen!</h1>
                </div>
                <button onclick="logout()" class="w-12 h-12 bg-red-500/20 hover:bg-red-500 rounded-2xl flex items-center justify-center transition-all border border-red-500/30 shadow-lg"><i class="fas fa-power-off"></i></button>
            </div>
            <div class="grid grid-cols-2 gap-4">
                <div class="stat-glass p-5 rounded-[2.5rem]">
                    <p class="text-[8px] font-black text-blue-200 uppercase tracking-widest mb-1 italic">Personal Score</p>
                    <div class="flex items-end gap-2"><span id="totalScoreText" class="text-3xl font-black italic">0</span><span class="text-[9px] font-bold mb-2 opacity-50 uppercase italic">Points</span></div>
                </div>
                <div class="stat-glass p-5 rounded-[2.5rem]">
                    <p class="text-[8px] font-black text-blue-200 uppercase tracking-widest mb-1 italic">Cloud Sync</p>
                    <div id="syncStatus" class="flex items-center gap-2 mt-2"><div class="w-2 h-2 bg-orange-400 rounded-full animate-pulse"></div><span class="text-[10px] font-black uppercase italic italic">Syncing...</span></div>
                </div>
            </div>
        </div>
    </nav>

    <div class="container mx-auto px-6 -mt-16 relative z-20">
        <div class="bg-white rounded-[3.5rem] shadow-2xl p-8 mb-6 border border-gray-100">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-black text-blue-900 text-[11px] uppercase tracking-widest italic leading-none">Aktivitas & Luaran</h3>
            </div>
            <div class="relative h-64 flex justify-center">
                <canvas id="scoreChart"></canvas>
            </div>
            <div id="chartLegend" class="grid grid-cols-2 gap-4 mt-8 pt-6 border-t border-gray-50"></div>
        </div>

        <div class="grid grid-cols-1 gap-4">
            <a href="penilaian_logbook.html" class="flex items-center gap-6 bg-white p-7 rounded-[3rem] shadow-xl border-b-8 border-orange-500 active:scale-95 group transition-all">
                <div class="w-14 h-14 bg-orange-100 rounded-2xl flex items-center justify-center text-orange-600 group-hover:bg-orange-500 group-hover:text-white transition-all"><i class="fas fa-tasks text-xl"></i></div>
                <div><h3 class="font-black text-blue-900 text-sm uppercase leading-none tracking-tight italic">Penilaian Logbook</h3><p class="text-[9px] text-gray-400 font-bold uppercase mt-1 italic italic tracking-widest">Validasi Portofolio</p></div>
            </a>
            <div class="grid grid-cols-2 gap-4">
                <a href="performa_dosen.html" class="bg-white p-7 rounded-[2.5rem] shadow-xl border-b-8 border-blue-900 active:scale-95 text-center group transition-all">
                    <div class="w-12 h-12 bg-blue-100 rounded-2xl flex items-center justify-center text-blue-900 mx-auto mb-2 group-hover:bg-blue-900 group-hover:text-white transition-all"><i class="fas fa-chart-line"></i></div>
                    <h3 class="font-black text-blue-900 text-[10px] uppercase italic">Performa</h3>
                </a>
                <a href="luaran_dosen.html" class="bg-white p-7 rounded-[2.5rem] shadow-xl border-b-8 border-green-600 active:scale-95 text-center group transition-all">
                    <div class="w-12 h-12 bg-green-100 rounded-2xl flex items-center justify-center text-green-700 mx-auto mb-2 group-hover:bg-green-700 group-hover:text-white transition-all"><i class="fas fa-file-signature"></i></div>
                    <h3 class="font-black text-blue-900 text-[10px] uppercase italic">Luaran</h3>
                </a>
            </div>
        </div>
    </div>

    <script>
        const scriptURL = "https://script.google.com/macros/s/AKfycbz67L492OrkaOvuZpq9k4RkAqNcLkEMh1pRenk3x_ylYD89J7KrlP6H6I2Y_MQPORPL8w/exec"; 
        const user = JSON.parse(localStorage.getItem('current_user'));

        if(!user || user.role.toUpperCase() !== "DOSEN") window.location.href = 'index.html';
        document.getElementById('dosenGreet').innerText = "Halo, " + user.name + "!";

        async function fetchAnalytics() {
            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "readDashboardAnalytics", nama_dosen: user.name })
                });
                const myData = await response.json();

                const stats = myData.reduce((acc, curr) => {
                    let key = curr.jenis || "Lainnya";
                    acc[key] = (acc[key] || 0) + (parseInt(curr.skor) || 0);
                    return acc;
                }, {});

                if (Object.keys(stats).length > 0) renderChart(stats);
                document.getElementById('syncStatus').innerHTML = '<div class="w-2 h-2 bg-green-500 rounded-full"></div><span class="text-[10px] font-black uppercase italic">Synced</span>';
            } catch (e) {
                document.getElementById('syncStatus').innerHTML = '<div class="w-2 h-2 bg-red-500 rounded-full"></div><span class="text-[10px] font-black uppercase italic">Error</span>';
            }
        }

        function renderChart(stats) {
            const ctx = document.getElementById('scoreChart').getContext('2d');
            const labels = Object.keys(stats), values = Object.values(stats);
            const total = values.reduce((a, b) => a + b, 0);
            document.getElementById('totalScoreText').innerText = total;

            const colors = ['#1e3a8a', '#f97316', '#10b981', '#6366f1', '#f43f5e'];
            new Chart(ctx, {
                type: 'doughnut',
                data: { labels: labels, datasets: [{ data: values, backgroundColor: colors, borderWidth: 0, hoverOffset: 15, borderRadius: 10 }] },
                options: { cutout: '80%', plugins: { legend: { display: false } }, maintainAspectRatio: false }
            });

            const legendContainer = document.getElementById('chartLegend');
            labels.forEach((label, i) => {
                legendContainer.innerHTML += `
                    <div class="flex items-center gap-3 p-2 bg-gray-50 rounded-2xl border border-gray-100">
                        <div class="w-3 h-3 rounded-full" style="background:${colors[i]}"></div>
                        <div><p class="text-[7px] font-black text-gray-400 uppercase italic leading-none mb-1">${label}</p><p class="text-[10px] font-black text-blue-900 italic">${stats[label]} pts</p></div>
                    </div>`;
            });
        }

        function logout() { localStorage.clear(); window.location.href = 'index.html'; }
        window.onload = fetchAnalytics;
    </script>
</body>
</html>
