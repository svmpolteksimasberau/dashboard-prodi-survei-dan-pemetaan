<script>
    // 1. Ambil data session login
    const user = JSON.parse(localStorage.getItem('current_user'));
    
    // 2. Proteksi Halaman
    if (!user) {
        window.location.href = 'index.html';
    } else {
        // Tampilkan Nama Asli (Akan muncul SAKINAH / IQBAL)
        document.getElementById('userName').innerText = user.name;
        document.getElementById('roleLabel').innerText = user.role.toUpperCase();
        
        // 3. Logika Tampilan Berdasarkan Role
        if (user.role === 'dosen') {
            document.getElementById('summaryDosen').classList.remove('hidden');
            document.getElementById('cardKPI').classList.remove('hidden');
            document.getElementById('cardLuaran').classList.remove('hidden');
            document.getElementById('cardMonitor').classList.remove('hidden');
        } else {
            // Role Mahasiswa
            document.getElementById('cardLogMhs').classList.remove('hidden');
        }
        
        // 4. Jalankan Hitung Statistik
        refreshRealData();
    }

    function refreshRealData() {
        let totalSkor = 0;
        let totalLuaran = 0;
        let totalMhs = 0;
        let totalPending = 0;

        // Loop melalui memori browser
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            
            // Hitung Skor (Jika ada)
            if (key.startsWith('kpi_score_')) {
                totalSkor += parseInt(localStorage.getItem(key)) || 0;
            }
            
            // Hitung Luaran (Jika ada)
            if (key.startsWith('luaran_count_')) {
                totalLuaran += parseInt(localStorage.getItem(key)) || 0;
            }

            // HITUNG MAHASISWA (Sesuai kunci index.html baru: user_db_)
            if (key.startsWith('user_db_')) {
                try {
                    const userData = JSON.parse(localStorage.getItem(key));
                    if (userData.role === 'mahasiswa') {
                        totalMhs++;
                        // Cek apakah mahasiswa ini sudah isi logbook (Key: log_NIM)
                        const logData = localStorage.getItem('log_' + userData.id);
                        if (!logData || JSON.parse(logData).length === 0) {
                            totalPending++;
                        }
                    }
                } catch(e) { console.error("Error parsing user data"); }
            }
        }

        // Update ke Tampilan
        document.getElementById('realSkorKolektif').innerText = totalSkor;
        document.getElementById('realTotalLuaran').innerText = totalLuaran;
        document.getElementById('realTotalMhs').innerText = totalMhs;
        document.getElementById('realLogbookPending').innerText = totalPending;
    }

    function logout() {
        // Hapus session login saja, jangan hapus database user_db_
        localStorage.removeItem('current_user');
        window.location.href = 'index.html';
    }
</script>
