<script>
    // 1. Ambil data user & data lama dari LocalStorage saat halaman dimuat
    const user = JSON.parse(localStorage.getItem('current_user'));
    let currentTotalScore = parseInt(localStorage.getItem('kpi_score_' + user.id)) || 0;
    
    // Ambil riwayat aktivitas (jika belum ada, buat array kosong)
    let kpiHistory = JSON.parse(localStorage.getItem('kpi_history_' + user.id)) || [];
    
    const counts = { Pengajaran: 0, Penelitian: 0, Pengabdian: 0, Administrasi: 0 };

    // Tampilkan skor lama ke layar
    document.getElementById('totalSkorDisplay').innerText = currentTotalScore;

    // Fungsi untuk merender tabel dari data yang tersimpan
    function renderHistory() {
        const body = document.getElementById('histBody');
        body.innerHTML = "";
        kpiHistory.forEach(item => {
            // Hitung distribusi untuk grafik
            if(counts[item.kategori] !== undefined) counts[item.kategori]++;
            
            const row = `
                <tr class="hover:bg-blue-50 transition border-l-4 border-transparent hover:border-blue-900">
                    <td class="p-4 font-bold text-gray-500 text-[10px]">${item.tanggal}</td>
                    <td class="p-4">
                        <span class="text-[10px] font-black uppercase text-blue-900 tracking-tighter">${item.kategori}</span><br>
                        <span class="text-gray-400 font-normal italic leading-relaxed text-[11px]">${item.deskripsi}</span>
                    </td>
                    <td class="p-4 text-center font-black text-blue-900">+5</td>
                </tr>
            `;
            body.insertAdjacentHTML('afterbegin', row);
        });
    }

    // Jalankan render pertama kali
    renderHistory();

    // 2. Logika saat Form di-Submit
    document.getElementById('kpiForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const newItem = {
            tanggal: document.getElementById('tgl').value,
            kategori: document.getElementById('kat').value,
            deskripsi: document.getElementById('desk').value
        };

        // Update Skor & Simpan
        currentTotalScore += 5;
        localStorage.setItem('kpi_score_' + user.id, currentTotalScore);
        document.getElementById('totalSkorDisplay').innerText = currentTotalScore;

        // Tambah ke History & Simpan Array ke LocalStorage
        kpiHistory.push(newItem);
        localStorage.setItem('kpi_history_' + user.id, JSON.stringify(kpiHistory));

        // Update Tampilan & Grafik
        renderHistory();
        myChart.data.datasets[0].data = Object.values(counts);
        myChart.update();

        this.reset();
    });
</script>
