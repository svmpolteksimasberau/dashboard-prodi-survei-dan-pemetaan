<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Logbook - Survei & Pemetaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .glass-nav { background: rgba(30, 58, 138, 0.95); backdrop-filter: blur(10px); }
        .tab-active { color: #f97316; border-bottom: 4px solid #f97316; }
    </style>
</head>
<body class="pb-24">

    <nav class="glass-nav text-white pt-12 pb-16 px-8 rounded-b-[3.5rem] shadow-2xl sticky top-0 z-50">
        <div class="flex justify-between items-start">
            <div>
                <p class="text-[10px] font-black text-orange-400 uppercase tracking-[0.2em] mb-1">Logbook Digital PSBC</p>
                <h1 id="userName" class="text-2xl font-black italic tracking-tighter uppercase">Memuat...</h1>
                <p id="userId" class="text-[10px] font-bold opacity-60 mt-1"></p>
            </div>
            <button onclick="logout()" class="bg-white/10 p-3 rounded-2xl hover:bg-red-500 transition-all">
                <i class="fas fa-power-off text-sm"></i>
            </button>
        </div>
    </nav>

    <main class="container mx-auto px-6 -mt-8 relative z-10 max-w-md">
        
        <div class="bg-white rounded-3xl shadow-xl flex mb-8 overflow-hidden border border-gray-100 p-2">
            <button onclick="switchTab('form')" id="tab-form" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest tab-active transition-all">
                <i class="fas fa-edit mr-2"></i> Lapor
            </button>
            <button onclick="switchTab('history')" id="tab-history" class="flex-1 py-4 text-[10px] font-black uppercase tracking-widest text-gray-400 transition-all">
                <i class="fas fa-history mr-2"></i> Riwayat
            </button>
        </div>

        <section id="section-form" class="space-y-6">
            <div class="bg-white p-8 rounded-[2.5rem] shadow-lg border border-gray-50">
                <h2 class="text-blue-900 font-black uppercase text-xs mb-6 flex items-center gap-2">
                    <span class="w-2 h-6 bg-orange-500 rounded-full"></span> Form Kegiatan Harian
                </h2>
                
                <div class="space-y-4">
                    <input type="date" id="tgl_kegiatan" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-900 font-bold text-sm text-gray-600">
                    
                    <input type="text" id="lokasi" placeholder="Lokasi (Contoh: Pit G, Workshop)" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-900 font-bold text-sm">
                    
                    <select id="jenis" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-900 font-bold text-sm text-gray-600 italic">
                        <option value="">-- Pilih Kategori --</option>
                        <option value="Terrestrial Survey">Terrestrial Survey</option>
                        <option value="GNSS/GPS">GNSS/GPS</option>
                        <option value="UAV/Drone">UAV/Drone</option>
                        <option value="Data Processing">Data Processing</option>
                    </select>

                    <textarea id="deskripsi" rows="4" placeholder="Apa yang Anda kerjakan hari ini?" class="w-full p-4 bg-gray-50 rounded-2xl border-none outline-none focus:ring-2 focus:ring-blue-900 font-bold text-sm"></textarea>
                    
                    <div class="p-4 bg-orange-50 rounded-2xl border border-orange-100">
                        <label class="text-[9px] font-black text-orange-600 uppercase mb-2 block">Lampiran Foto (Wajib)</label>
                        <input type="file" id="fotoInput" accept="image/*" class="text-[10px] font-bold text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-[10px] file:font-black file:bg-orange-500 file:text-white">
                    </div>

                    <button onclick="simpanLaporan()" id="btnSimpan" class="w-full bg-blue-900 text-white font-black py-5 rounded-2xl shadow-xl active:scale-95 hover:bg-blue-800 transition-all uppercase tracking-widest text-sm">
                        Kirim Laporan
                    </button>
                </div>
            </div>
        </section>

        <section id="section-history" class="hidden space-y-4">
            <div id="loadingStatus" class="text-center py-10 hidden">
                <i class="fas fa-spinner fa-spin text-blue-900 text-2xl mb-2"></i>
                <p class="text-[10px] font-bold text-gray-400 uppercase italic">Sinkronisasi Cloud...</p>
            </div>
            <div id="riwayatList" class="space-y-4">
                </div>
        </section>

    </main>

    <script>
        // CONFIG
        const scriptURL = "https://script.google.com/macros/s/AKfycbyeR9R4vHkkTak9Tr9gUMvuwG04TxDTd8_YVsHVmLBThSvpvLl976291pkcPV0EPwn6/exec";
        const user = JSON.parse(localStorage.getItem('current_user'));

        // PROTEKSI HALAMAN
        if(!user || user.role !== "MAHASISWA") {
            window.location.href = 'index.html';
        } else {
            document.getElementById('userName').innerText = user.name;
            document.getElementById('userId').innerText = "NIM: " + user.id;
        }

        // FUNGSI PINDAH TAB
        function switchTab(type) {
            const form = document.getElementById('section-form');
            const history = document.getElementById('section-history');
            const tForm = document.getElementById('tab-form');
            const tHistory = document.getElementById('tab-history');

            if(type === 'form') {
                form.classList.remove('hidden');
                history.classList.add('hidden');
                tForm.classList.add('tab-active');
                tHistory.classList.remove('tab-active');
            } else {
                form.classList.add('hidden');
                history.classList.remove('hidden');
                tForm.classList.remove('tab-active');
                tHistory.classList.add('tab-active');
                muatRiwayatCloud();
            }
        }

        // FUNGSI SIMPAN (DENGAN UPLOAD FOTO)
        async function simpanLaporan() {
            const btn = document.getElementById('btnSimpan');
            const fotoFile = document.getElementById('fotoInput').files[0];
            
            // Validasi Sederhana
            const tgl = document.getElementById('tgl_kegiatan').value;
            const lok = document.getElementById('lokasi').value;
            const des = document.getElementById('deskripsi').value;
            
            if(!tgl || !lok || !des) return alert("Lengkapi data laporan!");

            btn.disabled = true;
            btn.innerHTML = "Memproses...";

            let base64Foto = "";
            if(fotoFile) {
                const reader = new FileReader();
                base64Foto = await new Promise(resolve => {
                    reader.onload = e => resolve(e.target.result.split(',')[1]);
                    reader.readAsDataURL(fotoFile);
                });
            }

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "addLogbook",
                        nim: user.id,
                        nama: user.name,
                        tanggal: tgl,
                        lokasi: lok,
                        jenis: document.getElementById('jenis').value,
                        deskripsi: des,
                        foto: base64Foto,
                        rowId: Date.now(), // Unique ID untuk edit/hapus nanti
                        geotagging: "" // Bisa diisi geolocation jika perlu
                    })
                });

                const res = await response.json();
                if(res.success) {
                    alert("Laporan Berhasil Terkirim ke Cloud!");
                    location.reload();
                }
            } catch (err) {
                alert("Gagal kirim. Cek koneksi!");
                btn.disabled = false;
                btn.innerText = "Kirim Laporan";
            }
        }

        // FUNGSI TARIK DATA DARI CLOUD (SINKRONISASI)
        async function muatRiwayatCloud() {
            const container = document.getElementById('riwayatList');
            const loading = document.getElementById('loadingStatus');
            
            loading.classList.remove('hidden');
            container.innerHTML = "";

            try {
                const response = await fetch(scriptURL, {
                    method: 'POST',
                    body: JSON.stringify({ action: "readLogbook", nim: user.id })
                });
                
                const data = await response.json();
                loading.classList.add('hidden');

                if(data.length === 0) {
                    container.innerHTML = `<div class="bg-white p-10 rounded-3xl shadow text-center text-[10px] font-bold text-gray-400 uppercase italic">Belum ada catatan di database.</div>`;
                    return;
                }

                data.forEach(item => {
                    container.innerHTML += `
                        <div class="bg-white p-6 rounded-[2rem] shadow-md border-l-8 border-blue-900 relative">
                            <div class="flex justify-between items-start mb-2">
                                <p class="text-[9px] font-black text-orange-500 italic uppercase">${item.tanggal}</p>
                                <span class="text-[8px] bg-blue-50 text-blue-900 px-2 py-1 rounded-full font-bold uppercase">${item.jenis}</span>
                            </div>
                            <h4 class="font-black text-blue-900 text-xs uppercase mb-1">${item.lokasi}</h4>
                            <p class="text-[10px] text-gray-500 italic leading-relaxed mb-4">"${item.deskripsi}"</p>
                            
                            <div class="pt-4 border-t border-gray-100 flex justify-between items-center">
                                <div class="text-[8px] font-bold text-gray-400 uppercase">
                                    Skor: <span class="text-blue-900 font-black">${item.skor || 'Belum Dinilai'}</span>
                                </div>
                                ${item.foto !== "-" ? `<a href="${item.foto}" target="_blank" class="text-blue-500 text-[9px] font-black uppercase underline tracking-tighter">Lihat Foto</a>` : ''}
                            </div>
                        </div>
                    `;
                });
            } catch (e) {
                loading.innerHTML = "Gagal Sinkronisasi.";
            }
        }

        function logout() {
            localStorage.clear();
            window.location.href = 'index.html';
        }
    </script>
</body>
</html>
