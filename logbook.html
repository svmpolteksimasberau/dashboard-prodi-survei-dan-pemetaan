const scriptURL = "PASTE_URL_WEB_APP_BARU_DI_SINI";
const user = JSON.parse(localStorage.getItem('current_user'));
let logs = []; // Data akan diambil dari Cloud

if(user) {
    document.getElementById('userNameDisplay').innerText = user.name;
    loadCloudData(); // Panggil data saat halaman dibuka
}

async function loadCloudData() {
    const historyList = document.getElementById('historyList');
    historyList.innerHTML = '<div class="text-center py-10 text-gray-400 font-bold uppercase text-[10px] animate-pulse">Menyinkronkan Riwayat Cloud...</div>';
    
    try {
        const response = await fetch(scriptURL, {
            method: 'POST',
            body: JSON.stringify({ action: "readLogbook", nim: user.id })
        });
        logs = await response.json();
        render(); // Tampilkan data setelah didownload
    } catch (err) {
        historyList.innerHTML = '<div class="text-center py-10 text-red-400 font-bold text-[10px]">Gagal Sinkron Cloud</div>';
    }
}

// Fungsi render() tetap sama, tapi sekarang mengambil data dari variabel logs hasil download
function render() {
    const container = document.getElementById('historyList');
    let total = 0;
    if(logs.length === 0) {
        container.innerHTML = `<div class="text-center py-10 text-gray-300 font-bold uppercase text-[10px] tracking-widest">Belum ada riwayat di cloud</div>`;
        document.getElementById('totalScore').innerText = "0";
        return;
    }
    
    // Urutkan riwayat (terbaru di atas)
    logs.reverse();

    container.innerHTML = logs.map((l, i) => {
        total += parseInt(l.skor);
        return `
        <div class="bg-white p-6 rounded-[2.5rem] shadow-lg border-l-[12px] ${l.jenis === 'Survey' ? 'border-blue-900' : 'border-orange-500'} relative mb-4">
            <div class="flex justify-between items-start mb-4">
                <div class="flex gap-2">
                    <span class="bg-gray-100 text-[7px] font-black px-3 py-1 rounded-full text-gray-500 uppercase">${l.jenis}</span>
                    <span class="bg-orange-100 text-orange-600 text-[7px] font-black px-3 py-1 rounded-full uppercase">+${l.skor} Poin</span>
                </div>
                <div class="flex gap-3 text-gray-300">
                    <button onclick="editLog(${i})" class="hover:text-blue-900 transition"><i class="fas fa-pencil-alt text-xs"></i></button>
                    <button onclick="hapusLog('${l.rowId}', ${i})" class="hover:text-red-500 transition"><i class="fas fa-trash-alt text-xs"></i></button>
                </div>
            </div>
            <div class="mb-3">
                <h4 class="text-blue-900 font-black text-xs uppercase">${l.tanggal}</h4>
                <p class="text-orange-500 font-black text-[9px] uppercase tracking-tighter">${l.lokasi}</p>
            </div>
            <p class="text-gray-600 text-[10px] leading-relaxed mb-4 bg-gray-50 p-4 rounded-2xl">${l.deskripsi}</p>
            ${l.foto && l.foto !== "-" ? `<img src="${l.foto}" class="w-full h-40 object-cover rounded-2xl shadow-inner border border-gray-100">` : ''}
        </div>`;
    }).join('');
    document.getElementById('totalScore').innerText = total;
}

// Tambahkan aksi ini pada onsubmit form agar setelah kirim langsung refresh data cloud
// ... di dalam formLog.onsubmit ...
// await fetch(scriptURL, { method: 'POST', mode: 'no-cors', body: JSON.stringify(payload) });
// alert("Data Berhasil Disinkronkan ke Cloud!");
// location.reload(); // Reload akan memicu loadCloudData() lagi
