<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Logbook - Survei & Pemetaan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</head>
<body class="bg-gray-100 font-sans">

    <nav class="bg-blue-900 text-white p-4 shadow-lg sticky top-0 z-50">
        <div class="container mx-auto flex justify-between items-center text-xs font-bold uppercase">
            <a href="dashboard.html"><i class="fas fa-arrow-left mr-2"></i> Dashboard</a>
            <span>Logbook: <span id="displayUser"></span></span>
        </div>
    </nav>

    <div class="container mx-auto py-6 px-4 max-w-4xl">
        <div class="bg-white p-6 rounded-3xl shadow-lg mb-8 border-t-8 border-orange-600">
            <h2 class="text-xl font-black text-blue-900 uppercase mb-4">Input Kegiatan Harian</h2>
            <form id="logForm" class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <input type="hidden" id="editIndex" value="-1">
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Tanggal</label>
                    <input type="date" id="tgl" required class="w-full p-2 bg-gray-50 rounded-lg border">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Lokasi/Site</label>
                    <input type="text" id="lokasi" required class="w-full p-2 bg-gray-50 rounded-lg border">
                </div>
                <div class="md:col-span-2">
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Deskripsi Pekerjaan</label>
                    <textarea id="deskripsi" required class="w-full p-2 bg-gray-50 rounded-lg border" rows="3"></textarea>
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Kendala (Opsional)</label>
                    <input type="text" id="kendala" class="w-full p-2 bg-gray-50 rounded-lg border">
                </div>
                <div>
                    <label class="text-[10px] font-bold text-gray-400 uppercase">Bukti Foto</label>
                    <input type="file" id="foto" accept="image/*" class="w-full text-xs">
                </div>
                <button type="submit" id="btnSubmit" class="md:col-span-2 bg-blue-900 text-white p-3 rounded-xl font-bold uppercase hover:bg-orange-600 transition">
                    Simpan & Kirim Ke Sheets
                </button>
            </form>
        </div>

        <div class="bg-white rounded-3xl shadow-lg overflow-hidden">
            <div class="p-4 bg-gray-50 border-b flex justify-between items-center">
                <h3 class="font-bold text-blue-900 uppercase text-sm">Riwayat Logbook Lokal</h3>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left text-xs">
                    <thead class="bg-blue-900 text-white uppercase">
                        <tr>
                            <th class="p-3">Tanggal</th>
                            <th class="p-3">Kegiatan</th>
                            <th class="p-3">Aksi</th>
                        </tr>
                    </thead>
                    <tbody id="logTable"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        const SCRIPT_URL = "PASTE_URL_WEB_APP_APPS_SCRIPT_DISINI";
        const user = JSON.parse(localStorage.getItem('current_user'));
        if(!user) window.location.href = 'index.html';
        document.getElementById('displayUser').innerText = user.name;

        let logs = JSON.parse(localStorage.getItem('logs_' + user.id)) || [];

        function renderTable() {
            const table = document.getElementById('logTable');
            table.innerHTML = "";
            logs.forEach((item, index) => {
                table.innerHTML += `
                    <tr class="border-b">
                        <td class="p-3">${item.tanggal}</td>
                        <td class="p-3 font-bold">${item.lokasi} - ${item.deskripsi.substring(0,20)}...</td>
                        <td class="p-3 flex gap-2">
                            <button onclick="editLog(${index})" class="text-blue-600"><i class="fas fa-edit"></i></button>
                            <button onclick="deleteLog(${index})" class="text-red-600"><i class="fas fa-trash"></i></button>
                        </td>
                    </tr>
                `;
            });
        }

        document.getElementById('logForm').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('btnSubmit');
            btn.disabled = true;
            btn.innerText = "MENGIRIM...";

            const fotoFile = document.getElementById('foto').files[0];
            let base64Foto = "";
            if(fotoFile) {
                const reader = new FileReader();
                base64Foto = await new Promise(r => {
                    reader.onload = ev => r(ev.target.result.split(',')[1]);
                    reader.readAsDataURL(fotoFile);
                });
            }

            const newEntry = {
                tanggal: document.getElementById('tgl').value,
                lokasi: document.getElementById('lokasi').value,
                deskripsi: document.getElementById('deskripsi').value,
                kendala: document.getElementById('kendala').value || "-",
            };

            // Kirim ke Google Sheets
            try {
                await fetch(SCRIPT_URL, {
                    method: 'POST',
                    body: JSON.stringify({
                        action: "addLogbook",
                        nim: user.id,
                        nama: user.name,
                        foto: base64Foto,
                        ...newEntry
                    })
                });

                // Simpan di Lokal
                const editIdx = document.getElementById('editIndex').value;
                if(editIdx == -1) logs.push(newEntry);
                else logs[editIdx] = newEntry;

                localStorage.setItem('logs_' + user.id, JSON.stringify(logs));
                alert("Berhasil disimpan permanen!");
                document.getElementById('logForm').reset();
                document.getElementById('editIndex').value = "-1";
                renderTable();
            } catch(e) { alert("Gagal kirim!"); }
            
            btn.disabled = false;
            btn.innerText = "SIMPAN & KIRIM KE SHEETS";
        };

        window.deleteLog = (index) => {
            if(confirm("Hapus dari riwayat lokal? (Data di Sheets tetap ada)")) {
                logs.splice(index, 1);
                localStorage.setItem('logs_' + user.id, JSON.stringify(logs));
                renderTable();
            }
        };

        window.editLog = (index) => {
            const item = logs[index];
            document.getElementById('tgl').value = item.tanggal;
            document.getElementById('lokasi').value = item.lokasi;
            document.getElementById('deskripsi').value = item.deskripsi;
            document.getElementById('kendala').value = item.kendala;
            document.getElementById('editIndex').value = index;
            window.scrollTo(0,0);
        };

        renderTable();
    </script>
</body>
</html>
